<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTTP代理 - 管理控制台</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>HTTP代理 管理控制台</h1>
      <p class="subtitle">访问 <code>http://localhost:3030/{key}</code> 转发到映射的目标URL</p>
      <button class="btn-help" onclick="openHelpModal()">使用说明</button>
    </header>

    <div class="main-layout">
      <!-- 左侧配置区 -->
      <div class="config-panel">
        <!-- 路径映射 -->
        <section class="section collapsible">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <span class="collapse-icon">▼</span>
              <h2>路径映射</h2>
            </div>
            <button id="btn-add-mapping" class="btn btn-primary" onclick="event.stopPropagation()">+ 添加映射</button>
          </div>
          <div id="mappings-list" class="list section-content">
            <p class="empty">加载中...</p>
          </div>
        </section>

        <!-- 请求分组 -->
        <section class="section collapsible">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <span class="collapse-icon">▼</span>
              <h2>请求分组</h2>
            </div>
            <button id="btn-add-request-group" class="btn btn-primary" onclick="event.stopPropagation()">+ 添加分组</button>
          </div>
          <div id="request-groups-list" class="list section-content">
            <p class="empty">加载中...</p>
          </div>
        </section>

        <!-- 响应分组 -->
        <section class="section collapsible">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <span class="collapse-icon">▼</span>
              <h2>响应分组</h2>
            </div>
            <button id="btn-add-response-group" class="btn btn-primary" onclick="event.stopPropagation()">+ 添加分组</button>
          </div>
          <div id="response-groups-list" class="list section-content">
            <p class="empty">加载中...</p>
          </div>
        </section>
      </div>

      <!-- 右侧日志区 -->
      <div class="logs-panel">
        <section class="section collapsible">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <span class="collapse-icon">▼</span>
              <h2>请求日志</h2>
            </div>
            <div class="log-controls" onclick="event.stopPropagation()">
              <label class="auto-refresh">
                <input type="checkbox" id="auto-refresh" checked> 自动刷新
              </label>
              <select id="log-limit" class="log-limit" onchange="loadLogs()">
                <option value="20">20条</option>
                <option value="50" selected>50条</option>
                <option value="100">100条</option>
              </select>
              <button id="btn-refresh-logs" class="btn btn-secondary btn-sm">刷新</button>
              <button id="btn-clear-logs" class="btn btn-secondary btn-sm">清空日志</button>
            </div>
          </div>
          <div id="logs-list" class="logs-list section-content">
            <p class="empty">暂无请求日志</p>
          </div>
        </section>
      </div>
    </div>

    <!-- 映射编辑模态框 -->
    <div id="mapping-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="mapping-modal-title">添加映射</h3>
          <button class="btn-close" onclick="closeMappingModal()">&times;</button>
        </div>
        <form id="mapping-form">
          <input type="hidden" id="mapping-id">

          <div class="form-group">
            <label for="mapping-key">映射Key</label>
            <div class="input-with-button">
              <input type="text" id="mapping-key" required placeholder="如: iflow">
              <button type="button" id="btn-generate-key" class="btn btn-secondary btn-sm">随机生成</button>
            </div>
            <small class="hint">访问 /{key} 将转发到目标URL</small>
          </div>

          <div class="form-group">
            <label for="mapping-target">目标URL</label>
            <input type="text" id="mapping-target" required placeholder="如: https://api.example.com/v1/chat">
          </div>

          <div class="form-group">
            <label for="mapping-request-group">关联请求分组</label>
            <select id="mapping-request-group">
              <option value="">-- 不关联 --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="mapping-response-group">关联响应分组</label>
            <select id="mapping-response-group">
              <option value="">-- 不关联 --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="mapping-desc">描述 (可选)</label>
            <input type="text" id="mapping-desc" placeholder="描述这个映射的用途">
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="mapping-enabled" checked> 启用此映射
            </label>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn" onclick="closeMappingModal()">取消</button>
            <button type="submit" class="btn btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 请求分组编辑模态框 -->
    <div id="request-group-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 id="request-group-modal-title">添加请求分组</h3>
          <button class="btn-close" onclick="closeRequestGroupModal()">&times;</button>
        </div>
        <form id="request-group-form">
          <input type="hidden" id="request-group-id">

          <div class="form-group">
            <label for="request-group-name">分组名称</label>
            <input type="text" id="request-group-name" required placeholder="如: API认证">
          </div>

          <div class="form-group">
            <label for="request-group-desc">描述 (可选)</label>
            <input type="text" id="request-group-desc" placeholder="描述这个分组的用途">
          </div>

          <div class="form-group">
            <label>请求头操作</label>
            <div id="request-header-actions" class="actions-list"></div>
            <button type="button" class="btn btn-secondary" onclick="addRequestHeaderAction()">+ 添加操作</button>
          </div>

          <div class="form-group">
            <label>请求体处理</label>
            <select id="request-body-type" onchange="toggleRequestBodyConfig()">
              <option value="">不处理</option>
              <option value="script">脚本修改</option>
              <option value="replace">直接替换</option>
            </select>
            <div id="request-body-config" class="body-config hidden">
              <textarea id="request-body-content" rows="5" placeholder="脚本示例: return { ...body, newField: 'value' }"></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn" onclick="closeRequestGroupModal()">取消</button>
            <button type="submit" class="btn btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 响应分组编辑模态框 -->
    <div id="response-group-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 id="response-group-modal-title">添加响应分组</h3>
          <button class="btn-close" onclick="closeResponseGroupModal()">&times;</button>
        </div>
        <form id="response-group-form">
          <input type="hidden" id="response-group-id">

          <div class="form-group">
            <label for="response-group-name">分组名称</label>
            <input type="text" id="response-group-name" required placeholder="如: Mock响应">
          </div>

          <div class="form-group">
            <label for="response-group-desc">描述 (可选)</label>
            <input type="text" id="response-group-desc" placeholder="描述这个分组的用途">
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="response-mock-mode"> Mock模式 (不发起实际请求)
            </label>
          </div>

          <div class="form-group">
            <label>状态码</label>
            <input type="number" id="response-status-code" placeholder="留空则不修改" min="100" max="599">
          </div>

          <div class="form-group">
            <label>响应头操作</label>
            <div id="response-header-actions" class="actions-list"></div>
            <button type="button" class="btn btn-secondary" onclick="addResponseHeaderAction()">+ 添加操作</button>
          </div>

          <div class="form-group">
            <label>响应体处理</label>
            <select id="response-body-type" onchange="toggleResponseBodyConfig()">
              <option value="">不处理</option>
              <option value="script">脚本修改</option>
              <option value="replace">直接替换</option>
            </select>
            <div id="response-body-config" class="body-config hidden">
              <textarea id="response-body-content" rows="5" placeholder="脚本示例: return { ...body, modified: true }"></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn" onclick="closeResponseGroupModal()">取消</button>
            <button type="submit" class="btn btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 全屏查看请求详情模态框 -->
    <div id="fullscreen-modal" class="modal hidden">
      <div class="modal-content fullscreen-modal-content">
        <div class="modal-header">
          <h3 id="fullscreen-modal-title">请求详情</h3>
          <button class="btn-close" onclick="closeFullscreenModal()">&times;</button>
        </div>
        <div id="fullscreen-modal-body" class="fullscreen-modal-body">
        </div>
      </div>
    </div>

    <!-- 使用说明模态框 -->
    <div id="help-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h3>使用说明</h3>
          <button class="btn-close" onclick="closeHelpModal()">&times;</button>
        </div>
        <div class="help-content">
          <h4>1. 基本使用</h4>
          <p><strong>步骤一：</strong>创建路径映射，配置 Key（如 <code>api</code>）和目标 URL（如 <code>https://api.example.com/v1</code>）</p>
          <p><strong>步骤二：</strong>访问 <code>http://localhost:3030/api</code> 即可转发到 <code>https://api.example.com/v1</code></p>
          <p><strong>示例：</strong>配置 Key 为 <code>openai</code>，目标为 <code>https://api.openai.com/v1/chat/completions</code>，则：</p>
          <ul>
            <li><code>http://localhost:3030/openai</code> → <code>https://api.openai.com/v1/chat/completions</code></li>
            <li><code>http://localhost:3030/openai/xxx</code> → <code>https://api.openai.com/v1/chat/completions</code></li>
          </ul>
          <p><strong>注意：</strong>Key 后面的路径会被忽略，始终转发到配置的目标 URL</p>

          <h4>2. 请求分组</h4>
          <p>用于修改<strong>发出的请求</strong>，在映射中关联后生效：</p>
          <table class="help-table">
            <tr><td><strong>请求头操作</strong></td><td>添加/覆盖/删除请求头。如：添加 <code>Authorization: Bearer xxx</code></td></tr>
            <tr><td><strong>请求体处理</strong></td><td>脚本修改或直接替换请求体内容</td></tr>
          </table>

          <h4>3. 响应分组</h4>
          <p>用于修改<strong>收到的响应</strong>，在映射中关联后生效：</p>
          <table class="help-table">
            <tr><td><strong>Mock模式</strong></td><td>勾选后<strong>不发起实际请求</strong>，直接返回配置的响应内容，用于接口模拟</td></tr>
            <tr><td><strong>状态码</strong></td><td>修改响应状态码，如将 500 改为 200</td></tr>
            <tr><td><strong>响应头操作</strong></td><td>添加/覆盖/删除响应头</td></tr>
            <tr><td><strong>响应体处理</strong></td><td>脚本修改或直接替换响应体内容</td></tr>
          </table>

          <h4>4. Body 处理方式</h4>
          <p><strong>直接替换：</strong>完全替换为你输入的内容，原内容被丢弃</p>
          <p><strong>脚本修改：</strong>通过 JavaScript 脚本处理，脚本接收 <code>body</code> 参数，必须 <code>return</code> 结果</p>

          <h4>5. 脚本修改详解</h4>
          <p><strong>body 参数说明：</strong></p>
          <ul>
            <li>如果原始内容是<strong>有效 JSON</strong>，<code>body</code> 是解析后的 JavaScript 对象</li>
            <li>如果原始内容<strong>不是 JSON</strong>（如纯文本、HTML），<code>body</code> 是原始字符串</li>
            <li>脚本执行出错时，保留原始内容不做修改</li>
          </ul>

          <p><strong>示例 1：添加字段</strong></p>
          <pre class="help-code">// 给请求添加时间戳
return { ...body, timestamp: Date.now() };</pre>

          <p><strong>示例 2：删除敏感字段</strong></p>
          <pre class="help-code">// 删除密码字段
delete body.password;
delete body.token;
return body;</pre>

          <p><strong>示例 3：修改字段值</strong></p>
          <pre class="help-code">// 修改用户名为大写
body.username = body.username.toUpperCase();
return body;</pre>

          <p><strong>示例 4：解构删除多个字段</strong></p>
          <pre class="help-code">// 删除 password 和 secret，保留其他字段
const { password, secret, ...rest } = body;
return rest;</pre>

          <p><strong>示例 5：修改嵌套结构</strong></p>
          <pre class="help-code">// 过滤数组中的数据
body.data.items = body.data.items.filter(item => item.active);
body.data.count = body.data.items.length;
return body;</pre>

          <p><strong>示例 6：处理非 JSON 内容</strong></p>
          <pre class="help-code">// body 是字符串时的处理
if (typeof body === 'string') {
  return body.replace('old', 'new');
}
return body;</pre>

          <p><strong>示例 7：Mock 响应</strong></p>
          <pre class="help-code">// 在响应分组中开启 Mock 模式，Body 选择"直接替换"
// 输入以下内容作为模拟响应：
{"code": 0, "message": "success", "data": {"id": 123}}</pre>
        </div>
      </div>
    </div>
  </div>

  <script src="js/admin.js"></script>
</body>
</html>
